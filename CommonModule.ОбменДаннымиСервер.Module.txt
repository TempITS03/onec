
//Получает основной каталог выгрузки данных
//
Функция ОсновнойКаталогОбменаДанными() Экспорт
	
	Возврат Константы.КаталогОбменаДанными.Получить();
КонецФункции	

Процедура ОтправитьФайлОбменаПоПочте(ФайлОбмена,Получатели) Экспорт
	
	Отказ = Ложь;
	СтрОшибки = "";
	
	Файл = Новый Файл(ФайлОбмена);
	
	Если НЕ Файл.Существует() Тогда
		СтрОшибки = "Файл: " + ФайлОбмена + " не найден!";
	КонецЕсли;	
	
	Если НЕ ЗначениеЗаполнено(Получатели) Тогда
		СтрОшибки = СтрОшибки + Символы.ПС + "Не заполнены получатели!";
		Отказ = Истина;
	КонецЕсли;	
	
	//определим текущего пользователя
	НастройкиТекущегоПользователя = ОбщегоНазначения.ПолучитьЗначениеПеременной("глТекущийПользователь");
	
	Если Не ЗначениеЗаполнено(НастройкиТекущегоПользователя.АдресСервераSMTP)
		или Не ЗначениеЗаполнено(НастройкиТекущегоПользователя.ПортSMTP)
		или Не ЗначениеЗаполнено(НастройкиТекущегоПользователя.ПользовательSMTP)
		или Не ЗначениеЗаполнено(НастройкиТекущегоПользователя.ПарольSMTP) 
		или Не ЗначениеЗаполнено(НастройкиТекущегоПользователя.Отправитель) Тогда
		СтрОшибки = СтрОшибки + Символы.ПС + "Не заполнены основные параметры SMTP-сервера для текущего пользователя";
		Отказ = Истина;
	КонецЕсли;	
	
	Если Отказ Тогда
		Сообщение = Новый СообщениеПользователю;
		Сообщение.КлючДанных = НастройкиТекущегоПользователя;
		Сообщение.Текст = СтрОшибки;
		Сообщение.Сообщить();
		Возврат;
	КонецЕсли;	
	
	
	//Для объекта типа ИнтернетПочта создаем и заполняем почтовый профиль.
	ПочтовыйПрофиль = Новый ИнтернетПочтовыйПрофиль; 
	ПочтовыйПрофиль.АдресСервераSMTP   = НастройкиТекущегоПользователя.АдресСервераSMTP; 
	ПочтовыйПрофиль.ПортSMTP           = НастройкиТекущегоПользователя.ПортSMTP; 
	ПочтовыйПрофиль.ПользовательSMTP   = НастройкиТекущегоПользователя.ПользовательSMTP; 
	ПочтовыйПрофиль.ПарольSMTP         = НастройкиТекущегоПользователя.ПарольSMTP; 
	ПочтовыйПрофиль.ВремяОжидания      = НастройкиТекущегоПользователя.ВремяОжиданияСервера; 
	
	Почта = Новый ИнтернетПочта(); 
	Попытка 
		Почта.Подключиться(ПочтовыйПрофиль); 
	Исключение 
		Сообщить("ОБМЕН: Ошибка при подключении к почтовому профилю! Обмен не выполнен! " + 
		ОписаниеОшибки(), СтатусСообщения.ОченьВажное); 
		Возврат; 
	КонецПопытки; 

	ПочтовоеСообщение = Новый ИнтернетПочтовоеСообщение; 
	МассивОтправителя = ОбщегоНазначенияКлиентСервер.РазобратьСтрокуСПочтовымиАдресами(НастройкиТекущегоПользователя.Отправитель);
	ПочтовоеСообщение.Отправитель = МассивОтправителя.Получить(0).Адрес;
	ПочтовоеСообщение.Тема = "1С: Автообмен УВР по почте."; 
	ПочтовоеСообщение.Вложения.Добавить(ФайлОбмена, Файл.Имя); 
	МассивПолучателей = ОбщегоНазначенияКлиентСервер.РазобратьСтрокуСПочтовымиАдресами(Получатели);
	Для Каждого Адресат Из МассивПолучателей Цикл
		ПочтовоеСообщение.Получатели.Добавить(Адресат.Адрес);
	КонецЦикла;	
	Почта.Послать(ПочтовоеСообщение); 
	
	Сообщение = Новый СообщениеПользователю;
	Сообщение.Текст = "Файл: " + Файл.Имя + " отправлен по E-mail";
	Сообщение.Сообщить();
	
КонецПроцедуры	

Процедура ПолучитьСообщенияОбменаПоПочте(КаталогОбмена) Экспорт 

   //определим текущего пользователя
	НастройкиТекущегоПользователя = ОбщегоНазначения.ПолучитьЗначениеПеременной("глТекущийПользователь");
	Отказ = Ложь;
	СтрОшибки = "";
	Если Не ЗначениеЗаполнено(НастройкиТекущегоПользователя.АдресСервераPOP3)
		или Не ЗначениеЗаполнено(НастройкиТекущегоПользователя.ПортPOP3)
		или Не ЗначениеЗаполнено(НастройкиТекущегоПользователя.Пользователь)
		или Не ЗначениеЗаполнено(НастройкиТекущегоПользователя.Пароль) Тогда
		СтрОшибки = СтрОшибки + Символы.ПС + "Не заполнены основные параметры SMTP-сервера для текущего пользователя";
		Отказ = Истина;
	КонецЕсли;	
	
	Если Отказ Тогда
		Сообщение = Новый СообщениеПользователю;
		Сообщение.КлючДанных = НастройкиТекущегоПользователя;
		Сообщение.Текст = СтрОшибки;
		Сообщение.Сообщить();
		Возврат;
	КонецЕсли;	
	
	
	//Для объекта типа ИнтернетПочта создаем и заполняем почтовый профиль.
	ПочтовыйПрофиль = Новый ИнтернетПочтовыйПрофиль; 
	ПочтовыйПрофиль.АдресСервераPOP3  	= НастройкиТекущегоПользователя.АдресСервераPOP3; 
	ПочтовыйПрофиль.ПортPOP3          	= НастройкиТекущегоПользователя.ПортPOP3; 
	ПочтовыйПрофиль.Пользователь 		= НастройкиТекущегоПользователя.Пользователь; 
	ПочтовыйПрофиль.Пароль         		= НастройкиТекущегоПользователя.Пароль; 
	ПочтовыйПрофиль.ВремяОжидания      	= НастройкиТекущегоПользователя.ВремяОжиданияСервера; 
	
	Почта = Новый ИнтернетПочта(); 
	Попытка 
		Почта.Подключиться(ПочтовыйПрофиль); 
	Исключение 
		Сообщить("ОБМЕН: Ошибка при подключении к почтовому профилю! Обмен не выполнен! " + 
		ОписаниеОшибки(), СтатусСообщения.ОченьВажное); 
		Возврат; 
	КонецПопытки; 

   
   МассивСообщений = Новый Массив; 
   ВсеСообщения = Почта.Выбрать(Ложь); 

   //Отбираем среди всех писем те, которые имеют тему "1С:Обмен". 
   //Маленькое, но важное замечание:
   //считаем, что все полученные письма с темой "1С:Обмен" предназначены 
   //именно для текущего узла,
   //т.е. что у разных узлов в плане обмена РАЗНЫЕ электронные адреса.

   Для Каждого Сообщение Из ВсеСообщения Цикл 
   
      Если Сообщение.Тема <> "1С: Автообмен УВР по почте." Тогда 
         Продолжить; 
      КонецЕсли; 

      Попытка 
         МассивСообщений.Добавить(Сообщение); 

         //Вложение письма сохраняем на диске. 
         //Аккуратную проверку вложения оставим пока "за кадром." 

         Вложение = Сообщение.Вложения[0]; 
         ИмяФайлаСообщения = КаталогОбмена+"\" + Вложение.Name; 
         ДанныеОбмена = Вложение.Данные; 
         ДанныеОбмена.Записать(ИмяФайлаСообщения); 
   
      Исключение 
         Сообщить("ОБМЕН: Ошибка при получении данных обмена: " + ОписаниеОшибки(), 
                    СтатусСообщения.ОченьВажное); 
      КонецПопытки; 

   КонецЦикла; 
   
   Почта.УдалитьСообщения(МассивСообщений); 
   Почта.Отключиться(); 
   
КонецПроцедуры 

//Производит архивацию файла
//	ФайлИсточник - это полный путь к файлу который необходимо архивировать;
//	ФайлПриемник - полный путь уже где должен находится заархивированный файл;
//	Пароль - если нужно можно указать пароль;
//	Комментарий - описание файла
//
Процедура АрхивироватьФайл(ФайлИсточник,ФайлПриемник,Пароль=Неопределено,Комментарий=Неопределено) Экспорт
	
	ЗаписьZipФайла = Новый ЗаписьZipФайла;
	Попытка
		ЗаписьZipФайла.Открыть(ФайлПриемник, Пароль,Комментарий,МетодСжатияZIP.Сжатие,УровеньСжатияZIP.Максимальный);
		ЗаписьZipФайла.Добавить(СокрЛП(ФайлИсточник));
		ЗаписьZipФайла.Записать();
	Исключение
		#Если Клиент Тогда
			Сообщить(ОписаниеОшибки()); 
		#КонецЕсли 
	КонецПопытки;

КонецПроцедуры	

//Производит архивацию файла
//	ФайлИсточник - это полный путь к файлу который необходимо архивировать;
//	ФайлПриемник - полный путь уже где должен находится заархивированный файл;
//	Пароль - если нужно можно указать пароль;
//	Комментарий - описание файла
//
Процедура ИзвлечьФайлСАрхива(ФайлИсточник,Каталог,Пароль=Неопределено) Экспорт
	
	ЧтениеZipФайла = Новый ЧтениеZipФайла;
	Попытка
		ЧтениеZipФайла.Открыть(ФайлИсточник, Пароль);
		ЧтениеZipФайла.ИзвлечьВсе(Каталог);
		ЧтениеZipФайла.Закрыть();
	Исключение
		#Если Клиент Тогда
			Сообщить(ОписаниеОшибки()); 
		#КонецЕсли 
	КонецПопытки;

КонецПроцедуры	
